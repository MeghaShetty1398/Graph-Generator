<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.rawgit.com/eligrey/canvas-toBlob.js/f1a01896135ab378aa5c0118eadd81da55e698d8/canvas-toBlob.js"></script>
<script src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>
<script src="jquery-3.5.1.min.js"></script>
<style>
    .arc text {
        font: 15px sans-serif;
        text-anchor: middle;
    }
    .arc path {
        stroke: #fff;
    }
    .title {
        fill: teal;
        font-weight: bold;
    }
    h1{
        margin-left: 40%;
    }
    b{
        margin-left: 27%;
        color:black;
    }   
    .card-body{
        margin-left: 40%;
    }
    #dropdownList{
         width:100px;
         height: 30px;
    }
    svg{
        margin-left: 20%;
    }
</style>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
    $(document).ready(function(){
        $("#myFile").change(function(e){
            var fileName = e.target.files[0].name;
            var filetype=document.getElementById("filetype").value;
            if(filetype=="json"){
              // Get the data
                d3.json("http://localhost:3000/pie_data/"+fileName, function(error, data) {
                if (error) throw error;
                    // trigger render
                    draw(data);
                });
            }
            else{
              // Get the data
                d3.csv("http://localhost:3000/pie_data/"+fileName, function(error, data) {
                if (error) throw error;
                    // trigger render
                    draw(data);
               });
            }
        });
        $("#file_url").change(function(){
            var file_url=document.getElementById("file_url").value;
            if(filetype=="json"){
                // Get the data
                d3.json(file_url, function(error, data) {
                if (error) throw error;
                    // trigger render
                    draw(data);
                });
            }
            else{
                // Get the data
                d3.csv(file_url, function(error, data) {
                if (error) throw error;
                    // trigger render
                    draw(data);
               });
            }
        });
        d3.select('#saveButton').on('click', function(){
            var svg=d3.select("svg");
            var svgString = getSVGString(svg.node());
	        svgString2Image( svgString, 900, 700, 'png', save ); // passes Blob and filesize String to the callback

	        function save( dataBlob, filesize ){
		        saveAs( dataBlob, 'Pie Chart from D3' ); // FileSaver.js function
	        }
        });
    });
</script>
<script>
    // Set-up the export button
    // Below are the functions that handle actual exporting:
    // getSVGString ( svgNode ) and svgString2Image( svgString, width, height, format, callback )
    function getSVGString( svgNode ) {
        svgNode.setAttribute('xlink', 'http://www.w3.org/1999/xlink');
        var cssStyleText = getCSSStyles( svgNode );
        appendCSS( cssStyleText, svgNode );
        var serializer = new XMLSerializer();
        var svgString = serializer.serializeToString(svgNode);
        svgString = svgString.replace(/(\w+)?:?xlink=/g, 'xmlns:xlink='); // Fix root xlink without namespace
        svgString = svgString.replace(/NS\d+:href/g, 'xlink:href'); // Safari NS namespace fix
        return svgString;
      
        function getCSSStyles( parentElement ) {
            var selectorTextArr = [];
      
            // Add Parent element Id and Classes to the list
            selectorTextArr.push( '#'+parentElement.id );
            for (var c = 0; c < parentElement.classList.length; c++)
                if ( !contains('.'+parentElement.classList[c], selectorTextArr) )
                          selectorTextArr.push( '.'+parentElement.classList[c] );
      
            // Add Children element Ids and Classes to the list
            var nodes = parentElement.getElementsByTagName("*");
              for (var i = 0; i < nodes.length; i++) {
                  var id = nodes[i].id;
                  if ( !contains('#'+id, selectorTextArr) )
                      selectorTextArr.push( '#'+id );
                  var classes = nodes[i].classList;
                  for (var c = 0; c < classes.length; c++)
                      if ( !contains('.'+classes[c], selectorTextArr) )
                          selectorTextArr.push( '.'+classes[c] );
              }
              // Extract CSS Rules
              var extractedCSSText = "";
              for (var i = 0; i < document.styleSheets.length; i++) {
                  var s = document.styleSheets[i]; 
                  try {
                      if(!s.cssRules) continue;
                  } catch( e ) {
                          if(e.name !== 'SecurityError') throw e; // for Firefox
                          continue;
                      }
      
                  var cssRules = s.cssRules;
                  for (var r = 0; r < cssRules.length; r++) {
                      if ( contains( cssRules[r].selectorText, selectorTextArr ) )
                          extractedCSSText += cssRules[r].cssText;
                  }
              }
              return extractedCSSText;
      
              function contains(str,arr) {
                  return arr.indexOf( str ) === -1 ? false : true;
              }
      
          }
      
          function appendCSS( cssText, element ) {
              var styleElement = document.createElement("style");
              styleElement.setAttribute("type","text/css"); 
              styleElement.innerHTML = cssText;
              var refNode = element.hasChildNodes() ? element.children[0] : null;
              element.insertBefore( styleElement, refNode );
          }
      }
      
      
      function svgString2Image( svgString, width, height, format, callback ) {
          var format = format ? format : 'png';
      
          var imgsrc = 'data:image/svg+xml;base64,'+ btoa( unescape( encodeURIComponent( svgString ) ) ); // Convert SVG string to data URL
      
          var canvas = document.createElement("canvas");
          var context = canvas.getContext("2d");
      
          canvas.width = width;
          canvas.height = height;
      
          var image = new Image();
          image.onload = function() {
              context.clearRect ( 0, 0, width, height );
              context.drawImage(image, 0, 0, width, height);
      
              canvas.toBlob( function(blob) {
                  var filesize = Math.round( blob.length/1024 ) + ' KB';
                  if ( callback ) callback( blob, filesize );
              });
      
              
          };
      
          image.src = imgsrc;
      }
      
</script>
</head>
<body>
    <h1>Pie Chart</h1>
    <div class="card  text-white" style="background-color: #F7ADC7;">
    <div class="card-body">
        Choose File type:
        <select id="filetype">
            <option value="json" selected>JSON</option>
            <option value="csv">CSV</option>
        </select><br>
    </div>
    <div style="margin-left: 25%;">
        Upload your json/csv data:   <input type="file" id="myFile" onchange="onCreateGraph()">
        <B style="margin-left:0%;">OR</B>
        <input id="file_url" type="text" placeholder="URL" style="margin-left:6%;">
    </div>    
    <b>* Please upload json/csv file with atleast two column.</b>
    <b>* Second column must be number type.<button class="btn btn-success" id="saveButton"  style="margin-left:22%;" >Download Graph</button></b><br>
    </div>
    <svg width="800" height="600"></svg>
    <script>
    function draw(data){
        var svg = d3.select("svg"),
            width = svg.attr("width"),
            height = svg.attr("height"),
            radius = Math.min(width, height) / 2;
        
        var g = svg.append("g")
                   .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

        var color = d3.scaleOrdinal(['#EC4C86','#695EE9','#4EE075','#EFD243','#AE6708']);

        
        var path = d3.arc()
                     .outerRadius(radius - 10)
                     .innerRadius(0);

        var label = d3.arc()
                      .outerRadius(radius)
                      .innerRadius(radius - 100);
        var k=[];
        var columnsIn = data[0];
        for(var key in columnsIn){
            k.push(key);
        } 
        var pie = d3.pie().value(function(d) { 
            return d[k[1]]; 
        });

        var arc = g.selectAll(".arc")
                .data(pie(data))
                .enter()
                .append("g")
                .attr("class", "arc");

        arc.append("path")
            .attr("d", path)
            .attr("fill", function(d) {  return color(d.data[k[0]]); });
        
        console.log(arc)
        
        arc.append("text")
            .attr("transform", function(d) { 
                return "translate(" + label.centroid(d) + ")"; 
            })
            .attr("dy", ".55em")
            .text(function(d) { return d.data[k[0]]+" : "+d.data[k[1]]; });
            svg.append("g")
            .attr("transform", "translate(" + (width / 2 - 20) + "," + 10 + ")")
            .append("text")
            .text("")
            .attr("class", "title")
        }           
    </script>
</body>
</html>